#force root

if [[ $(/usr/bin/id -u) -ne 0 ]]; then

echo "root is required to run this script"
exit
fi


#debugging



set -x

#load variables
#source "/etc/libvirt/hooks/kvm.conf"



#unbind vtconsoles

#echo 0 > /sys/class/vtconsole/vtcon0/bind
#echo 0 > /sys/class/vtconsole/vtcon1/bind
##unbind efi framebuffer
#echo efi-framebuffer.0 > /sys/bus/platform/drivers/efi-framebuffer/unbind

#avoid race

sleep 10

#unload nvidia

#modprobe -r nvidia_drm
#modprobe -r nvidia_modeset
#modprobe -r drm_kms_helper
#modprobe -r nvidia
#modprobe -r i2c_nvidia_gpu
#modprobe -r drm
#modprobe -r nvidia_uvm

#unbind gpu

virsh nodedev-detach pci_0000_0c_00_1
virsh nodedev-detach pci_0000_0c_00_0
virsh nodedev-detach pci_0000_0d_00_1
virsh nodedev-detach pci_0000_0d_00_0
#virsh nodedev-detach $VIRSH_AUDIO_CONTROLLER
#virsh nodedev-detach $VIRSH_USB_CONTROLLER
#virsh nodedev-detach $VIRSH_SIGNAL_CONTROLLER
#virsh nodedev-detach $VIRSH_AUDIO1
#virsh nodedev-detach $VIRSH_AUDIO2
#virsh nodedev-detach $VIRSH_AUDIO3
#virsh nodedev-detach $VIRSH_USB_HUB1
#virsh nodedev-detach $VIRSH_USB_HUB2
#virsh nodedev-detach $VIRSH_USB_HUB3
#virsh nodedev-detach $VIRSH_USB_HUB4
#virsh nodedev-detach $VIRSH_USB_HUB5
#virsh nodedev-detach $VIRSH_USB_HUB6
#virsh nodedev-detach $VIRSH_USB_HUB7
#virsh nodedev-detach $VIRSH_USB_HUB8






#load vfio

modprobe vfio
modprobe vfio_pci
modprobe vfio_iommu_type1

mount /dev/sdd1 /mnt
#mount /dev/sde1 /10tbhdd
#virsh start vm1
#virsh start vm2
#starting services


systemctl start sshd
systemctl start cockpit.socket
#systemctl start vncserver@:2.service
systemctl start sddm
